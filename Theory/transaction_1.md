Транзакции
---

Транзакция - некая группа последовательных операций, то есть действий по 
изменению состояния в БД к примеру, которая представляет собой единую 
операцию.

Для работы транзакция должна выполнять требования ACID.

По суть это выполнение группы SQL запросов, все эти запросы выполняются 
в своей виртуальной среде, и в случае успешного выполнения их всех, 
результат их работы переносится в жесткий диск, реальную БД.

Тут есть 3 последовательных операции, открыть транз, выполнить работу, и
закрыть транзакцию, закрытие транзакции подразумевает либо полный откат и не 
внесение изменений в жесткий диск, либо перевод в реальную БД.

Закрыть транзакцию можно как:

1) `COMMIT` - подтверждаем все внесенные изменения.
2) `ROLLBACK` - откатываем их все.

Если не закрыть транзакцию `ROLLBACK`, то сделанные действия хоть и не 
выполнятся, но и не будет завершена сама транзакция, и она останется 
просто висеть. 

---
ACID
---

Это набор требований для обеспечения сохранности данных в БД.

1) `Atomicity` — Атомарность
2) `Consistency` — Согласованность
3) `Isolation` — Изолированность
4) `Durability` — Надёжность

**Atomicity**

Каждая транзакция должна быть выполнена полностью или не выполнена вовсе.
То есть если в транз сломается один запрос то будут отменены все запросы, 
зачем это нужно ? Скажем мы переводим деньги 2 отдельными запросами, 
один снял деньги с нашего счета, а другой провалился из-за того что у 
получателя итек срок карточки, но деньги уже списались, сама БД не имеет 
представления о связях между этими запросами, так что для БД все в порядке,
но для бизнеса это нарушение логики.

За этим и нужна атомарность, чтобы отменить все операции если где то произошла 
ошибка, то есть чтобы Бд рассматривала все эти группы операций как единую.

`EOT` - end of transaction транз достигшая своего завершения, и записавшая
данные на жесткий диск.

**Consistency**

Это правило вытекает из первого, тесть если транз выполнилась то БД по идеи
остается консистентной или согласованной, то есть БД перешла из одного 
состояния в другой.

**Isolation**

Изолированность - во время выполнения транз другие параллельные транз не должны
оказывать влияния на ее результат.

Скажем транзакцию выполняют 100 человек одновременно, что может произойти в 
таком случае, происходит масса ужасных событий.

Для борьбы с ними используется 2 основных метода, каждый из которых 
изолирует транзакцию: 

1) Блокировка - Данные блокируются, можно заблокировать хоть всю таблицу.
2) Версия - Создается различные версии данных, и пока одна транзакция не
заколотить, другие транзакции будут работать со старыми версиями данных.
   
**Durability**

Если транзакция выполнилась, то пользователь уверен, что все изменения внесены в БД.

---
Режимы блокировки в `PostgreSQL` для Изоляции(Isolation) транзакций.
---

https://habr.com/ru/company/postgrespro/blog/462877/

**Конкурентный доступ** - это одновременный доступ нескольких процессов, сами 
процессы могут выполняться как параллельно так и последовательно в режиме разделения 
времени, не важно как они выполняются, они работают с одними данными.

Если нет такой конкуренции, то и не требуется блокировки.

Блокировки(locks) - замок.

Блокировка это отметка о захвате объекта транзакцией, и ограничение доступа к
блокированному объекту с целью предотвращения коллизий которые могут возникнуть при 
одновременно обращении разных процессов кк одним данным в БД. Блокировки нужны, чтобы
упорядочить конкурентный доступ к разделяемым ресурсам.

В СУБД блокировкой управляет сама система СУБД, если процессы обращаются к некому 
приложению то это уже ложится на плечи программиста.

На более низком уровне для управления доступом процессов к одному ресурсу, используются
механизмы семафоров или мьютексы.

После того как процесс освобождает ресурс, он переходит под контроль другого процесса, 
другие процессы ожидают своей очереди, помимо блокировки возможен вариант работы с 
различными версиями данных.

Ресурсом может выступать все что угодно от табл в Бд до структуры данных в памяти, лишь бы 
этому объекту можно было дать адрес блокировки.

В СУБД PG есть долговременные и кратковременные блокировки:

1) Долговременные - могут захватывать до конца транзакции, к ним относятся таблицы(отношения)
   и строки, PG управляет этим автоматически.
2) Кратковременные - захват на несколько инструкций процессора, или на несколько долей секунд,
такими PG управляет полностью самостоятельно.

**Блокировки объектов в PG** - относятся к длительным блокировкам, могут блокировать целые 
отношения(таблицы) или индексы или последовательности, эти блокировки обычно защищают от 
исполнения нескольких транзакций по изменению данных одновременно.

Все блокировки можно посмотреть в представлении pg_locks

Ресурсы могут блокироваться как в совместимом режиме так и не в совместимом, если в не 
совместимом, то транзакция, что пытается получить доступ к заблокированному ресурсу, встает в 
очередь и ждет освобождения, ожидающие процессы засыпают и не потребляют ресурсов 
процессора, и просыпаются при его освобождении.

Возможны ситуации когда для исполнения одной транз треб другая которая заблокирована, в так 
ситуации PG сам прерывает работу одной из транзакций.

[//]: # (1&#41; распределённых системах)

[//]: # (2&#41; concurrency в распределённых системах)

[//]: # (3&#41; concurrency в БД )

[//]: # (4&#41; конкурентности и параллелизме в рамках ОС )

[//]: # (5&#41; Хинты в БД)

[//]: # (6&#41; Разница между семафором и мьютексом)

[//]: # (7&#41; примитивы синхронизации&#40;семафором и мьютексом&#41; при конкурентном доступе )

[//]: # (к разных процессов к одному набору данных.)


